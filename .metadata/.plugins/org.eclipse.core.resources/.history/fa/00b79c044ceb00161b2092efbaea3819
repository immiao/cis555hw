package edu.upenn.cis455.webserver.utils;

import java.io.BufferedReader;
import java.io.File;
import java.io.FileInputStream;
import java.io.IOException;
import java.io.InputStream;
import java.io.InputStreamReader;
import java.io.OutputStream;
import java.io.PrintWriter;
import java.nio.file.Path;
import java.nio.file.Paths;
import java.text.SimpleDateFormat;
import java.util.Date;
import java.util.HashMap;
import java.util.TimeZone;

public class HttpParser {
	private InputStream is;
	private String rootDir;
	
	// Response Initial Line
	static private byte[] http10ok200 = "HTTP/1.0 200 OK\r\n".getBytes();
	static private byte[] http10error400 = "HTTP/1.0 400 Bad Request\r\n".getBytes();
	static private byte[] http10error404 = "HTTP/1.0 404 Not Found\r\n".getBytes();
	static private byte[] http10error501 = "HTTP/1.0 501 Not Implemented\r\n".getBytes();
	static private byte[] http11ok200 = "HTTP/1.1 200 OK\r\n".getBytes();
	static private byte[] http11error400 = "HTTP/1.1 400 Bad Request\r\n".getBytes();
	static private byte[] http11error404 = "HTTP/1.1 404 Not Found\r\n".getBytes();
	static private byte[] http11error501 = "HTTP/1.1 501 Not Implemented\r\n".getBytes();
	
	// Initial Line
	private String method;
	private String dir;
	private String version;
	
	// Header
	private HashMap<String, String> headerMap;
	
	public boolean ParseInitialLine(String[] initialLine) {
		if (initialLine.length != 3)
			return false;
		method = initialLine[0];
		
		// handle absolute URL
		if (initialLine[1].contains("http:/"))
			initialLine[1] = initialLine[1].substring("http:/".length());
		
		File file = new File(initialLine[1]);
		try {
			dir  = file.getCanonicalPath();
			System.out.println("CAN: " + dir);
			
		} catch (IOException e) {
			e.printStackTrace();
		}
		version = initialLine[2];
		return true;
	}
	
	public boolean ParseHeader(BufferedReader in) {
		try {
			String line = in.readLine();
			while (!line.isEmpty()) {
				String[] headerline = line.split(":", 2);
				if (headerline.length < 2)
					return false;
				headerMap.put(headerline[0].trim().toLowerCase(), headerline[1].trim());
				line = in.readLine();
			}
			return true;
		} catch (Exception e) {
			e.printStackTrace();
			return false;
		}
	}
	
	// initialized function is executed in the main thread
	public HttpParser(InputStream is, String rootDir) {
		this.is = is;
		this.rootDir = rootDir;
		
		headerMap = new HashMap<String, String>();
	}
	
	public byte[] GetResult() {
    	InputStreamReader reader = new InputStreamReader(is);
    	BufferedReader in = new BufferedReader(reader);

    	byte[] initialLineByte = null;
    	byte[] headerByte = null;
    	byte[] bodyByte = null;
    	
    	try {
        	if (!ParseInitialLine(in.readLine().split(" "))) {
        		initialLineByte = http10error400;
        		headerByte = "\r\n".getBytes();
        	}
        	// HTTP/1.0
        	else if (version.equals("HTTP/1.0")) {
            	String path = new String(rootDir + dir);
            	File file = new File(path);
            	
            	headerByte = "\r\n".getBytes();
	        	if (method.equals("GET")) {
	        		initialLineByte = http10ok200;
		        	if (file.isDirectory()) {
		        		File[] files = file.listFiles();
		        		String result = new String("*****This is a directory.*****\n\n");
		        		for (File f : files) {
		        			result += f.getName() + "\n";
		        		}
			        	bodyByte = result.getBytes();				    	
		        	}
		        	else {
			        	bodyByte = new byte[(int)file.length()];
				    	FileInputStream fis = new FileInputStream(file);
				    	fis.read(bodyByte);
				    	fis.close();
		        	}
	        	}
	        	else if (method.equals("HEAD")) {
			    	FileInputStream fis = new FileInputStream(file);
			    	initialLineByte = http10ok200;
	        	}
	        	else if (method.equals("POST"))
	        		initialLineByte = http10error501;
	        	else
	        		initialLineByte = http10error400;
        	}
        	// HTTP/1.1
        	else if (version.equals("HTTP/1.1")) {
        		String headerStr = new String();
        		// date
        		Date date = new Date();
        		SimpleDateFormat format = new SimpleDateFormat("EEE, d MMM yyyy, hh:mm:ss z");
        		format.setTimeZone(TimeZone.getTimeZone("GMT"));
        		System.out.println(format.format(date));
        		headerStr += "Date: " + format.format(date);
        		
        		if (!ParseHeader(in)) {
        			initialLineByte = http11error400;
        		}
        		else {
            		// check if HOST header exists
            		if (!headerMap.containsKey("host")) {
            			initialLineByte = http11error400;
            		}
            		else {
                		// handle absolute URL
                		String prefix0 = "/" + headerMap.get("host");
                		String prefix1 = "/" + headerMap.get("host").split(":")[0];   		
                		if (dir.contains(prefix0))
                			dir = dir.substring(prefix0.length());
                		else if (dir.contains(prefix1))
                			dir = dir.substring(prefix1.length());
    		
                    	String path = new String(rootDir + dir);
                    	File file = new File(path);
        	        	if (method.equals("GET")) {
        	        		initialLineByte = http11ok200;
        		        	if (file.isDirectory()) {
        		        		File[] files = file.listFiles();
        		        		String result = new String("*****This is a directory.*****\n\n");
        		        		for (File f : files) {
        		        			result += f.getName() + "\n";
        		        		}
        			        	bodyByte = result.getBytes();
        		        	}
        		        	else {
        		        		bodyByte = new byte[(int)file.length()];
        				    	FileInputStream fis = new FileInputStream(file);
        				    	fis.read(bodyByte);
        				    	fis.close();			    	
        		        	}
        	        	}
        	        	else if (method.equals("HEAD")) {
        			    	FileInputStream fis = new FileInputStream(file);
        			    	initialLineByte = http11ok200;
        	        	}
        	        	else if (method.equals("POST")) {
        	        		initialLineByte = http11error501;
        	        	}
        	        	else
        	        		initialLineByte = http11error400;
            		}
        		}    			
        		headerByte = headerStr.getBytes();
        	}
        	else {
        		initialLineByte = http10error400;
        		headerByte = "\r\n".getBytes();
        	}
	    	
    	} catch (Exception e) {
    		initialLineByte = http10error400;
    		headerByte = "\r\n".getBytes();
    	} 
    	int initialLineLength = 0;
    	int headerLength = 0;
    	int bodyLength = 0;
    	
    	if (initialLineByte != null) initialLineLength = initialLineByte.length;
    	if (headerByte != null) headerLength = headerByte.length;
    	if (bodyByte != null) bodyLength = bodyByte.length;
    	
    	byte[] result = new byte[initialLineLength + headerLength + bodyLength];
    	int offset = 0;
    	
    	if (initialLineByte != null) {
    		System.out.println("initial line null");
	    	System.arraycopy(initialLineByte, 0, result, 0, initialLineByte.length);
	    	offset += initialLineByte.length;
    	}
    	if (headerByte != null) {
    		System.out.println("header null");
    		System.arraycopy(headerByte, 0, result, offset, headerByte.length);
    		offset += headerByte.length;
    	}
    	
    	if (bodyByte != null) {
    		System.out.println("initial line null");
    		System.arraycopy(bodyByte, 0, result, offset, bodyByte.length);
    	}
    	
    	return result;
	}
}
